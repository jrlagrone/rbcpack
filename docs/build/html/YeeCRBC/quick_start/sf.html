<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Free space Yee scheme with CRBC example (Fortran and C mix) &#8212; RBCPack  documentation</title>
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-inverse navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html">
          rbcpack</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Components <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Yee/FDTD</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../index.html#downloads-and-respository">Downloads and Respository</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#documentation">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#acknowledgments">Acknowledgments</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../Utilities/index.html">Utilities</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../Utilities/index.html#optimal-cosines">Optimal Cosines</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contrib.html">rbcpack Contributors</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Current Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Free space Yee scheme with CRBC example (Fortran and C mix)</a><ul>
<li><a class="reference internal" href="#compile-fortran-yee-scheme-with-crbc-library">Compile Fortran Yee scheme with CRBC library</a></li>
<li><a class="reference internal" href="#call-crbc-library-in-fortran">Call CRBC library in Fortran</a></li>
<li><a class="reference internal" href="#setup-crbc-for-fortran-yee-solver">Setup CRBC for fortran Yee solver</a></li>
<li><a class="reference internal" href="#output">Output</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary">  <ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Yee/FDTD</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../index.html#downloads-and-respository">Downloads and Respository</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../index.html#licensing">Licensing</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#documentation">Documentation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../index.html#user-guides">User Guides</a></li>
<li class="toctree-l3"><a class="reference internal" href="../index.html#known-issues">Known Issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="../index.html#theory-results-and-publications">Theory, Results, and Publications</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#acknowledgments">Acknowledgments</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../Utilities/index.html">Utilities</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../Utilities/index.html#optimal-cosines">Optimal Cosines</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contrib.html">rbcpack Contributors</a></li>
</ul>

<form action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
    <div class="body col-md-9 content" role="main">
      
  <div class="section" id="free-space-yee-scheme-with-crbc-example-fortran-and-c-mix">
<h1>Free space Yee scheme with CRBC example (Fortran and C mix)<a class="headerlink" href="#free-space-yee-scheme-with-crbc-example-fortran-and-c-mix" title="Permalink to this headline">¶</a></h1>
<p>Similar to the waveguide case, instead of setting boundaries to CRBC_PEC, one should set all 6 faces to be CRBC_CRBC:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">d</span><span class="o">-&gt;</span><span class="n">boundaries</span><span class="p">[</span><span class="n">CRBC_XLeft</span><span class="p">]</span>  <span class="o">=</span> <span class="n">CRBC_CRBC</span><span class="p">;</span>
<span class="n">d</span><span class="o">-&gt;</span><span class="n">boundaries</span><span class="p">[</span><span class="n">CRBC_XRight</span><span class="p">]</span> <span class="o">=</span> <span class="n">CRBC_CRBC</span><span class="p">;</span>
<span class="n">d</span><span class="o">-&gt;</span><span class="n">boundaries</span><span class="p">[</span><span class="n">CRBC_YLeft</span><span class="p">]</span>  <span class="o">=</span> <span class="n">CRBC_CRBC</span><span class="p">;</span>
<span class="n">d</span><span class="o">-&gt;</span><span class="n">boundaries</span><span class="p">[</span><span class="n">CRBC_YRight</span><span class="p">]</span> <span class="o">=</span> <span class="n">CRBC_CRBC</span><span class="p">;</span>
<span class="n">d</span><span class="o">-&gt;</span><span class="n">boundaries</span><span class="p">[</span><span class="n">CRBC_ZLeft</span><span class="p">]</span>  <span class="o">=</span> <span class="n">CRBC_CRBC</span><span class="p">;</span>
<span class="n">d</span><span class="o">-&gt;</span><span class="n">boundaries</span><span class="p">[</span><span class="n">CRBC_ZRight</span><span class="p">]</span> <span class="o">=</span> <span class="n">CRBC_CRBC</span><span class="p">;</span>
</pre></div>
</div>
<p>the <em>external_c_code.c</em> in <a class="reference download internal" download="" href="../../_downloads/080dd336aceedeb54e89f21ff7cfdf4f/ToyFDTD_CRBC.tar.gz"><code class="xref download docutils literal notranslate"><span class="pre">ToyFDTD_CRBC.tar.gz</span></code></a> has been tested working with fortran Yee scheme solver as well. The function ended with underscore ‘_’ is by default used by fortran code. Due to the copyright, we only put fortran code pieces here, just to illustrate how to use CRBC library.</p>
<div class="section" id="compile-fortran-yee-scheme-with-crbc-library">
<h2>Compile Fortran Yee scheme with CRBC library<a class="headerlink" href="#compile-fortran-yee-scheme-with-crbc-library" title="Permalink to this headline">¶</a></h2>
<p>The CRBC library is written in C++/C, the <em>external_c_code.c</em> can be used an example of interface function between Fortran and C. The compiling process might look like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>setenv yeecrbc_DIR ~/YeeCRBC/lib
gfortran -C -c -fno-align-commons YeeSolver.f
gcc -c -L$(yeecrbc_DIR) -I$(yeecrbc_DIR)/../include/crbc -lyeecrbc -lgfortran  external_c_codes.c
g++ -C  -o run.x YeeSolver.o -L$(yeecrbc_DIR) -I$(yeecrbc_DIR)/../include/crbc external_c_codes.o -lyeecrbc -lgfortran
</pre></div>
</div>
</div>
<div class="section" id="call-crbc-library-in-fortran">
<h2>Call CRBC library in Fortran<a class="headerlink" href="#call-crbc-library-in-fortran" title="Permalink to this headline">¶</a></h2>
<p>We declare a integer type variable in fortran to hold the C pointer to CRBC library:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">integer</span> <span class="n">cptr</span>
</pre></div>
</div>
<p>Before the main time iteration, we call crbc_init() to initialize the CRBC library in fortran:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">call</span> <span class="n">crbc_init</span><span class="p">(</span><span class="n">cptr</span><span class="p">,</span><span class="n">dx</span><span class="p">,</span><span class="n">dy</span><span class="p">,</span><span class="n">dz</span><span class="p">,</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">,</span><span class="n">mxx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">mxy</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">mxz</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">nt</span><span class="p">,</span><span class="n">dt</span><span class="p">,</span><span class="n">cc</span><span class="p">)</span>
</pre></div>
</div>
<p>nx,ny,nz are number of cubic Yee cells along each axis. nt is total number of time iterations. mxx+1,mxy+1,mxz+1 stand for leading dimension for Ex,Ey,Ez field. In this case, the E and H field in fortran is defined as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">real</span><span class="o">*</span><span class="mi">8</span> <span class="n">e</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">mxx</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">mxy</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">mxz</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">real</span><span class="o">*</span><span class="mi">8</span> <span class="n">h</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">mxx</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">mxy</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">mxz</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<p>Before the end of the time iteration, usually at the place where you used to call PML the last time, we call:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">call</span> <span class="n">computeBoundary</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="n">cptr</span><span class="p">)</span>
</pre></div>
</div>
<p>to compute the CRBC. We can also export solution in VTK format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">call</span> <span class="n">writeefield</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="n">cptr</span><span class="p">,</span><span class="n">vtkfilename</span><span class="p">)</span>
</pre></div>
</div>
<p>Due to the string difference in fortran and C, one should add a space ‘ ‘ at the end of vtkfilename string.</p>
</div>
<div class="section" id="setup-crbc-for-fortran-yee-solver">
<h2>Setup CRBC for fortran Yee solver<a class="headerlink" href="#setup-crbc-for-fortran-yee-solver" title="Permalink to this headline">¶</a></h2>
<p>CRBC initialization is done in crbc_init_():</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">d</span><span class="o">-&gt;</span><span class="n">boundaries</span><span class="p">[</span><span class="n">CRBC_XLeft</span><span class="p">]</span>  <span class="o">=</span> <span class="n">CRBC_CRBC</span><span class="p">;</span>
<span class="o">...</span>
</pre></div>
</div>
<p>delta, low_index[], high_index[] are set in setup_crbc_(). Meaning of those variables are discussed in detail in Waveguide Yee scheme section. In the current setting, we assume source is in the middle of domain, and Yee cells looks like</p>
<div class="figure align-center" id="fig-yee-cell1" style="width: 120%">
<a class="reference internal image-reference" href="../../_images/cell1.png"><img alt="image of a Yee cell" src="../../_images/cell1.png" style="width: 100%;" /></a>
</div>
</div>
<div class="section" id="output">
<h2>Output<a class="headerlink" href="#output" title="Permalink to this headline">¶</a></h2>
<p>Here are some pictures of electromagnetic waves leave the domain without reflection using Fortran Yee solver with CRBC.</p>
<div class="figure align-default" id="fig-free">
<img alt="../../_images/F11.png" src="../../_images/F11.png" />
</div>
<div class="figure align-default">
<img alt="../../_images/F12.png" src="../../_images/F12.png" />
</div>
<div class="figure align-default">
<img alt="../../_images/F13.png" src="../../_images/F13.png" />
</div>
<div class="figure align-default">
<img alt="../../_images/F14.png" src="../../_images/F14.png" />
</div>
</div>
</div>


    </div>
      
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
<div id="sourcelink">
  <a href="../../_sources/YeeCRBC/quick_start/sf.rst.txt"
     rel="nofollow">Source</a>
</div>
      
    </p>
    <p>
    <a href="../../contrib.html">rbcpack Contributors </a><br />
        &copy; Copyright 2015-2016, rbcpack.org.<br/>
    </p>
  </div>
</footer>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-71984541-1', 'auto');
  ga('send', 'pageview');

</script>


  </body>
</html>